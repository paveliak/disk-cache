#!/bin/sh

set -e

PREREQ=""

prereqs()
{
	echo "${PREREQ}"
}

case "${1}" in
	prereqs)
		prereqs
		exit 0
		;;
esac

echo "dm-cache-ramdisk: Starting..."

# Calculate 25% of total RAM in KB
TOTAL_RAM_KB=$(grep MemTotal /proc/meminfo | awk '{print $2}')
CACHE_SIZE_KB=$((TOTAL_RAM_KB / 4))
META_SIZE_KB=$((CACHE_SIZE_KB / 100))
DATA_SIZE_KB=$((CACHE_SIZE_KB - META_SIZE_KB))

echo "dm-cache-ramdisk: Total RAM: $((TOTAL_RAM_KB / 1024)) MB"
echo "dm-cache-ramdisk: Cache per mount: $((CACHE_SIZE_KB / 1024)) MB"

modprobe -r brd || true
modprobe brd rd_nr=1 rd_size=$CACHE_SIZE_KB
modprobe dm-cache
modprobe dm-cache-smq

sleep 1

# Calculate sizes in 512-byte sectors
META_SECTORS=$((META_SIZE_KB * 2))
DATA_SECTORS=$((DATA_SIZE_KB * 2))

echo "Creating dm-cache"
dmsetup create "cache-meta-root" --table "0 $META_SECTORS linear /dev/ram0 0"
dmsetup create "cache-data-root" --table "0 $DATA_SECTORS linear /dev/ram0 $META_SECTORS"

ROOT_DEV=$(readlink -f /dev/disk/by-label/cloudimg-rootfs)
ROOT_SECTORS=$(blockdev --getsz "$ROOT_DEV")
ROOT_SECTORS_ADJ=$((ROOT_SECTORS & ~7))

echo "Remounting root for $ROOT_DEV, $ROOT_SECTORS -> $ROOT_SECTORS_ADJ"
umount /root
dmsetup create "cached-root" --table "0 $ROOT_SECTORS_ADJ cache /dev/mapper/cache-meta-root /dev/mapper/cache-data-root $ROOT_DEV 256 1 writeback smq 2 migration_threshold 100"
mount /dev/mapper/cached-root "${rootmnt?}"

dmsetup status "cached-root"

echo "dm-cache-ramdisk: Setup complete"
